<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignalR MesajlaÅŸma Ã–rneÄŸi</title>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .message { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .user-message { background-color: #e3f2fd; margin-left: 20px; }
        .support-message { background-color: #f3e5f5; margin-right: 20px; }
        .online-users { background-color: #e8f5e8; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .typing-indicator { font-style: italic; color: #666; }
        .message-input { width: 100%; padding: 10px; margin: 10px 0; }
        .send-button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .status { padding: 5px 10px; border-radius: 3px; margin: 5px; display: inline-block; }
        .online { background-color: #4caf50; color: white; }
        .offline { background-color: #f44336; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ CMK IT Talep - AnlÄ±k MesajlaÅŸma</h1>
        
        <div>
            <h3>BaÄŸlantÄ± Durumu</h3>
            <div id="connectionStatus">BaÄŸlanÄ±yor...</div>
        </div>

        <div class="online-users">
            <h3>ğŸŸ¢ Ã‡evrimiÃ§i KullanÄ±cÄ±lar</h3>
            <div id="onlineUsers">YÃ¼kleniyor...</div>
        </div>

        <div>
            <h3>MesajlaÅŸma</h3>
            <div>
                <label>Talep ID:</label>
                <input type="number" id="requestId" value="1" style="width: 100px; padding: 5px;">
                <button onclick="joinRoom()">Odaya KatÄ±l</button>
                <button onclick="leaveRoom()">Odadan AyrÄ±l</button>
            </div>
            
            <div id="messages" style="height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
                <!-- Mesajlar burada gÃ¶rÃ¼necek -->
            </div>

            <div>
                <input type="text" id="messageInput" class="message-input" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()" class="send-button">GÃ¶nder</button>
            </div>

            <div id="typingIndicator" class="typing-indicator" style="display: none;">
                <!-- YazÄ±yor gÃ¶stergesi -->
            </div>
        </div>

        <div>
            <h3>Test ButonlarÄ±</h3>
            <button onclick="markMessageAsRead(1)">Mesaj 1'i Okundu Ä°ÅŸaretle</button>
            <button onclick="updateLastSeen()">Son GÃ¶rÃ¼lme ZamanÄ±nÄ± GÃ¼ncelle</button>
            <button onclick="getOnlineUsers()">Ã‡evrimiÃ§i KullanÄ±cÄ±larÄ± Yenile</button>
        </div>
    </div>

    <script>
        let connection = null;
        let currentRequestId = 1;

        // SignalR baÄŸlantÄ±sÄ±nÄ± baÅŸlat
        async function startConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/messageHub", {
                    accessTokenFactory: () => {
                        // Burada JWT token'Ä±nÄ±zÄ± dÃ¶ndÃ¼rÃ¼n
                        return localStorage.getItem('authToken') || '';
                    }
                })
                .build();

            // BaÄŸlantÄ± olaylarÄ±
            connection.onclose(async () => {
                console.log("BaÄŸlantÄ± kapatÄ±ldÄ±");
                document.getElementById('connectionStatus').innerHTML = '<span class="status offline">BaÄŸlantÄ± Kesildi</span>';
                setTimeout(startConnection, 5000);
            });

            // Mesaj alma
            connection.on("ReceiveMessage", (message) => {
                addMessageToUI(message);
            });

            // Mesaj okundu bildirimi
            connection.on("MessageRead", (data) => {
                console.log(`Mesaj ${data.messageId} kullanÄ±cÄ± ${data.userId} tarafÄ±ndan okundu`);
                updateMessageReadStatus(data.messageId, data.userId);
            });

            // KullanÄ±cÄ± Ã§evrimiÃ§i/Ã§evrimdÄ±ÅŸÄ±
            connection.on("UserOnline", (userId) => {
                console.log(`KullanÄ±cÄ± ${userId} Ã§evrimiÃ§i oldu`);
                updateUserStatus(userId, true);
            });

            connection.on("UserOffline", (userId) => {
                console.log(`KullanÄ±cÄ± ${userId} Ã§evrimdÄ±ÅŸÄ± oldu`);
                updateUserStatus(userId, false);
            });

            // YazÄ±yor gÃ¶stergesi
            connection.on("UserTyping", (data) => {
                showTypingIndicator(data.userId, data.isTyping);
            });

            // Ã‡evrimiÃ§i kullanÄ±cÄ±lar
            connection.on("OnlineUsers", (users) => {
                updateOnlineUsers(users);
            });

            // KullanÄ±cÄ± durumu deÄŸiÅŸikliÄŸi (API'den gelen)
            connection.on("UserStatusChanged", (data) => {
                console.log(`KullanÄ±cÄ± durumu deÄŸiÅŸti: ${data.userId} - ${data.isOnline ? 'Ã‡evrimiÃ§i' : 'Ã‡evrimdÄ±ÅŸÄ±'}`);
                updateUserStatus(data.userId, data.isOnline);
                // Ã‡evrimiÃ§i kullanÄ±cÄ± listesini yenile
                loadOnlineUsers();
            });

            try {
                await connection.start();
                console.log("SignalR baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±");
                document.getElementById('connectionStatus').innerHTML = '<span class="status online">BaÄŸlÄ±</span>';
                
                // Ã‡evrimiÃ§i kullanÄ±cÄ±larÄ± al
                await connection.invoke("GetOnlineUsers");
            } catch (err) {
                console.error("SignalR baÄŸlantÄ± hatasÄ±:", err);
                document.getElementById('connectionStatus').innerHTML = '<span class="status offline">BaÄŸlantÄ± HatasÄ±</span>';
            }
        }

        // Odaya katÄ±l
        async function joinRoom() {
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                currentRequestId = parseInt(document.getElementById('requestId').value);
                await connection.invoke("JoinRequestRoom", currentRequestId);
                console.log(`Talep ${currentRequestId} odasÄ±na katÄ±ldÄ±`);
            }
        }

        // Odadan ayrÄ±l
        async function leaveRoom() {
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                await connection.invoke("LeaveRequestRoom", currentRequestId);
                console.log(`Talep ${currentRequestId} odasÄ±ndan ayrÄ±ldÄ±`);
            }
        }

        // Mesaj gÃ¶nder
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message && connection && connection.state === signalR.HubConnectionState.Connected) {
                await connection.invoke("SendMessage", currentRequestId, message);
                messageInput.value = '';
            }
        }

        // Enter tuÅŸu ile mesaj gÃ¶nder
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // MesajÄ± UI'ya ekle
        function addMessageToUI(message) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.innerHTML = `
                <strong>Mesaj ${message.id}:</strong> ${message.message}
                <br><small>GÃ¶nderen: ${message.senderId} | Tarih: ${new Date(message.createdDate).toLocaleString()}</small>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Mesaj okundu durumunu gÃ¼ncelle
        function updateMessageReadStatus(messageId, userId) {
            console.log(`Mesaj ${messageId} kullanÄ±cÄ± ${userId} tarafÄ±ndan okundu`);
        }

        // KullanÄ±cÄ± durumunu gÃ¼ncelle
        function updateUserStatus(userId, isOnline) {
            const status = isOnline ? 'online' : 'offline';
            console.log(`KullanÄ±cÄ± ${userId} durumu: ${status}`);
        }

        // Ã‡evrimiÃ§i kullanÄ±cÄ±larÄ± gÃ¼ncelle
        function updateOnlineUsers(users) {
            const onlineUsersDiv = document.getElementById('onlineUsers');
            onlineUsersDiv.innerHTML = users.map(user => 
                `<span class="status ${user.isOnline ? 'online' : 'offline'}">
                    ${user.user ? user.user.firstName + ' ' + user.user.lastName : 'KullanÄ±cÄ± ' + user.userId}
                    ${user.isOnline ? 'ğŸŸ¢' : 'ğŸ”´'}
                </span>`
            ).join(' ');
        }

        // YazÄ±yor gÃ¶stergesi
        function showTypingIndicator(userId, isTyping) {
            const indicator = document.getElementById('typingIndicator');
            if (isTyping) {
                indicator.textContent = `KullanÄ±cÄ± ${userId} yazÄ±yor...`;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // MesajÄ± okundu iÅŸaretle
        async function markMessageAsRead(messageId) {
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                await connection.invoke("MarkMessageAsRead", messageId);
            }
        }

        // Son gÃ¶rÃ¼lme zamanÄ±nÄ± gÃ¼ncelle
        async function updateLastSeen() {
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                await connection.invoke("UpdateLastSeen");
            }
        }

        // Ã‡evrimiÃ§i kullanÄ±cÄ±larÄ± al
        async function getOnlineUsers() {
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                await connection.invoke("GetOnlineUsers");
            }
        }

        // Sayfa yÃ¼klendiÄŸinde baÄŸlantÄ±yÄ± baÅŸlat
        window.addEventListener('load', startConnection);
    </script>
</body>
</html>
